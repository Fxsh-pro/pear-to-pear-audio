<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebRTC Video Chat</title>
    <link href="http://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="row mb-3 mt-3 justify-content-md-center">
        <div id="user-name"></div>
        <button id="call" class="btn btn-primary col-1">Call!</button>
        <button id="hangup" class="col-1 btn btn-primary">Hangup</button>
        <div id="answer" class="col"></div>
    </div>
    <div id="videos">
        <div id="video-wrapper">
            <div id="waiting" class="btn btn-warning">Waiting for answer...</div>
            <video class="video-player" id="local-video" autoplay playsinline controls></video>
        </div>
        <video class="video-player" id="remote-video" autoplay playsinline controls></video>
    </div>
</div>
<script>
    const userName = "Rob-" + Math.floor(Math.random() * 100000);
    document.querySelector('#user-name').innerHTML = userName;

    const socket = new WebSocket("ws://localhost:8080/signaling");

    socket.onopen = () => {
        console.log("WebSocket connection established.");
    };

    socket.onmessage = (message) => {
        const data = JSON.parse(message.data);
        if (data.type === 'offer') {
            answerOffer(data);
        } else if (data.type === 'answer') {
            addAnswer(data);
        } else if (data.type === 'iceCandidate') {
            addNewIceCandidate(data.candidate);
        }
    };

    const localVideoEl = document.querySelector('#local-video');
    const remoteVideoEl = document.querySelector('#remote-video');

    let localStream;
    let remoteStream;
    let peerConnection;

    const peerConfiguration = {
        iceServers: [
            {
                urls: [
                    'stun:stun.l.google.com:19302',
                    'stun:stun1.l.google.com:19302'
                ]
            }
        ]
    };

    const call = async () => {
        await fetchUserMedia();
        await createPeerConnection();

        const offer = await peerConnection.createOffer();
        peerConnection.setLocalDescription(offer);
        socket.send(JSON.stringify({ type: 'offer', offer: offer, userName }));
    };

    const answerOffer = async (offerObj) => {
        await fetchUserMedia();
        await createPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offerObj.offer));
        const answer = await peerConnection.createAnswer();
        peerConnection.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: 'answer', answer: answer, userName }));
    };

    const addAnswer = async (answerObj) => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answerObj.answer));
    };

    const fetchUserMedia = () => {
        return navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                localVideoEl.srcObject = stream;
                localStream = stream;
            })
            .catch(err => console.log(err));
    };

    const createPeerConnection = () => {
        peerConnection = new RTCPeerConnection(peerConfiguration);
        remoteStream = new MediaStream();
        remoteVideoEl.srcObject = remoteStream;

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({ type: 'iceCandidate', candidate: event.candidate, userName }));
            }
        };

        peerConnection.ontrack = event => {
            event.streams[0].getTracks().forEach(track => {
                remoteStream.addTrack(track);
            });
        };
    };

    const addNewIceCandidate = (iceCandidate) => {
        peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));
    };

    document.querySelector('#call').addEventListener('click', call);
</script>
</body>
</html>
